function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
import{T as D,f as P,E as S,b as U,G as W,o as Q,p as A,L as $}from"./index-CuGlkaG1.js";class z extends D{#n=new Map;#t=new Map;registerDeviceClass(e){this.#n.set(e.name,e)}registerDevice(e){this.#t.set(e.id,e)}updateDeviceState(e,n,i){}getDeviceClass(e){return this.#n.get(e)}getDevice(e){return this.#t.get(e)}defineDeviceClass(e,n,i){const s=this,r=class f{static parent=s;static name=e;static _state=n;static _events=i;static#e=new D;deviceClass=f;id;state;constructor(o,u){if(f.parent.getDevice(o))throw new Error(`Device with id "${o}" already exists`);Object.defineProperty(this,"id",{value:o,writable:!1}),this.state=u||n.createDefault(),f.parent.registerDevice(this)}static addListener(o,u){return f.#e.addListener(o,u),f}static on(o,u){return f.#e.on(o,u),f}static once(o,u){return f.#e.once(o,u),f}static prependListener(o,u){return f.#e.prependListener(o,u),f}static prependOnceListener(o,u){return f.#e.prependOnceListener(o,u),f}static off(o,u){return f.#e.off(o,u),f}static removeAllListeners(o){return f.#e.removeAllListeners(o),f}static removeListener(o,u){return f.#e.removeListener(o,u),f}static emit(o,...u){return f.#e.emit(o,...u)}static eventNames(){return f.#e.eventNames()}static rawListeners(o){return f.#e.rawListeners(o)}static listeners(o){return f.#e.listeners(o)}static listenerCount(o){return f.#e.listenerCount(o)}static getMaxListeners(){return f.#e.getMaxListeners()}static setMaxListeners(o){return f.#e.setMaxListeners(o),f}};return this.registerDeviceClass(r),r}receiveEvent(e){this.#t.get(e.sourceId)?.deviceClass.emit(e.event,e.sourceId,e.data)}}var V={type:"sync",importFFI:()=>P(()=>import("./ffi-DGtPOqi5.js"),__vite__mapDeps([])).then(t=>t.QuickJSFFI),importModuleLoader:()=>P(()=>import("./emscripten-module.browser-CQTyY9rm.js"),__vite__mapDeps([])).then(t=>t.default)},q=V;async function K(t){let e=k(await t),[n,i,{QuickJSWASMModule:s}]=await Promise.all([e.importModuleLoader().then(k),e.importFFI(),P(()=>import("./module-HMQCEAUF-CYYojbOj.js"),__vite__mapDeps([])).then(k)]),r=await n();r.type="sync";let a=new i(r);return new s(r,a)}function k(t){return t&&"default"in t&&t.default?t.default&&"default"in t.default&&t.default.default?t.default.default:t.default:t}var X=Object.defineProperty,Y=(t,e,n)=>e in t?X(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,p=(t,e,n)=>(Y(t,typeof e!="symbol"?e+"":e,n),n);const Z=t=>{const e=new ee(t);return new Proxy(t,{get(n,i,s){return i in e?e[i]:Reflect.get(n,i,s)}})};class ee{constructor(e){p(this,"context"),p(this,"fn"),p(this,"fnGenerator"),p(this,"fnCounter",Number.MIN_SAFE_INTEGER),p(this,"fnMap",new Map),p(this,"newFunction",(i,s)=>{this.fnCounter++;const r=this.fnCounter;return this.fnMap.set(r,s),this.context.unwrapResult(this.context.callFunction(this.fnGenerator,this.context.undefined,this.context.newString(i),this.context.newNumber(s.length),this.context.newNumber(r),this.fn))}),this.context=e;const n=this.fnMap;this.fn=this.context.newFunction("",function(i,...s){const r=e.getNumber(i),a=n.get(r);if(!a)throw new Error("function is not registered");return a.call(this,...s)}),this.fnGenerator=e.unwrapResult(e.evalCode(`((name, length, id, f) => {
        const fn = function(...args) {
          return f.call(this, id, ...args);
        };
        fn.name = name;
        fn.length = length;
        return fn;
      })`))}disposeEx(){this.fnGenerator.dispose(),this.fn.dispose()}}const te=[[Symbol,"Symbol"],[Symbol.prototype,"Symbol.prototype"],[Object,"Object"],[Object.prototype,"Object.prototype"],[Function,"Function"],[Function.prototype,"Function.prototype"],[Boolean,"Boolean"],[Boolean.prototype,"Boolean.prototype"],[Array,"Array"],[Array.prototype,"Array.prototype"],[Error,"Error"],[Error.prototype,"Error.prototype"],[EvalError,"EvalError"],[EvalError.prototype,"EvalError.prototype"],[RangeError,"RangeError"],[RangeError.prototype,"RangeError.prototype"],[ReferenceError,"ReferenceError"],[ReferenceError.prototype,"ReferenceError.prototype"],[SyntaxError,"SyntaxError"],[SyntaxError.prototype,"SyntaxError.prototype"],[TypeError,"TypeError"],[TypeError.prototype,"TypeError.prototype"],[URIError,"URIError"],[URIError.prototype,"URIError.prototype"],...Object.getOwnPropertyNames(Symbol).filter(t=>typeof Symbol[t]=="symbol").map(t=>[Symbol[t],`Symbol.${t}`])];function ne(t,e){const n=t.unwrapResult(t.evalCode(e)),i=(s,...r)=>t.unwrapResult(t.callFunction(n,s??t.undefined,...r));return i.dispose=()=>n.dispose(),i.alive=!0,Object.defineProperty(i,"alive",{get:()=>n.alive}),i}function v(t,e,n,...i){const s=ne(t,e);try{return s(n,...i)}finally{s.dispose()}}function se(t,e,n){return t.dump(v(t,"Object.is",void 0,e,n))}function re(t,e,n){return t.dump(v(t,"(a, b) => a instanceof b",void 0,e,n))}function ie(t,e){return t.dump(v(t,'a => typeof a === "object" && a !== null || typeof a === "function"',void 0,e))}function oe(t,e){const n=JSON.stringify(e);return n?v(t,"JSON.parse",void 0,t.newString(n)):t.undefined}function ae([t,e],n){try{return n(t)}finally{e&&t.dispose()}}function M(t,e){try{return e(...t.map(n=>n[0]))}finally{for(const[n,i]of t)i&&n.dispose()}}function ue(t){return"handle"in t}function ce(t){return ue(t)?t.handle:t}function le(t,e,n,i){var s;let r;for(const a of i)if(r=a(e,t),r)break;return r?(s=n(e,r))!=null?s:r:void 0}function pe(t,e){return typeof t!="symbol"?void 0:v(e,"d => Symbol(d)",void 0,t.description?e.newString(t.description):e.undefined)}function de(t,e){return t instanceof Date?v(e,"d => new Date(d)",void 0,e.newNumber(t.getTime())):void 0}const fe=[pe,de];function he(t){return typeof t=="function"&&/^class\s/.test(Function.prototype.toString.call(t))}function x(t){return typeof t=="function"||typeof t=="object"&&t!==null}function me(t,e){const n=new Set,i=s=>{if(!(!x(s)||n.has(s)||e?.(s,n)===!1)){if(n.add(s),Array.isArray(s)){for(const r of s)i(r);return}if(typeof s=="object"){const r=Object.getPrototypeOf(s);r&&r!==Object.prototype&&i(r)}for(const r of Object.values(Object.getOwnPropertyDescriptors(s)))"value"in r&&i(r.value),"get"in r&&i(r.get),"set"in r&&i(r.set)}};return i(t),n}function ye(){let t=()=>{},e=()=>{};return{promise:new Promise((n,i)=>{t=n,e=i}),resolve:t,reject:e}}function L(t,e,n,i){const s=t.newObject(),r=(o,u)=>{const l=i(o),d=typeof u.value>"u"?void 0:i(u.value),c=typeof u.get>"u"?void 0:i(u.get),h=typeof u.set>"u"?void 0:i(u.set);t.newObject().consume(m=>{Object.entries(u).forEach(([y,g])=>{const _=y==="value"?d:y==="get"?c:y==="set"?h:g?t.true:t.false;_&&t.setProp(m,y,_)}),t.setProp(s,l,m)})},a=Object.getOwnPropertyDescriptors(e);Object.entries(a).forEach(([o,u])=>r(o,u)),Object.getOwnPropertySymbols(a).forEach(o=>r(o,a[o])),v(t,"Object.defineProperties",void 0,n,s).dispose(),s.dispose()}function ve(t,e,n,i,s,r){var a;if(typeof e!="function")return;const o=t.newFunction(e.name,function(...l){const d=i(this),c=l.map(h=>i(h));if(he(e)&&x(d)){const h=new e(...c);return Object.entries(h).forEach(([m,y])=>{t.setProp(this,m,n(y))}),this}return n(r?r(e,d,c):e.apply(d,c))}).consume(l=>v(t,`Cls => {
          const fn = function(...args) { return Cls.apply(this, args); };
          fn.name = Cls.name;
          fn.length = Cls.length;
          return fn;
        }`,void 0,l)),u=(a=s(e,o))!=null?a:o;return L(t,e,o,n),u}function ge(t,e,n){var i;const s=oe(t,e);return(i=n(e,s))!=null?i:s}function _e(t,e,n,i){var s;if(typeof e!="object"||e===null)return;const r=Array.isArray(e)?t.newArray():t.newObject(),a=(s=i(e,r))!=null?s:r,o=Object.getPrototypeOf(e),u=o&&o!==Object.prototype&&o!==Array.prototype?n(o):void 0;return u&&v(t,"Object.setPrototypeOf",void 0,a,u).dispose(),L(t,e,r,n),a}function be(t,e){switch(typeof e){case"undefined":return t.undefined;case"number":return t.newNumber(e);case"string":return t.newString(e);case"boolean":return e?t.true:t.false;case"object":return e===null?t.null:void 0}}function we(t,e,n,i){var s;if(!(e instanceof Promise))return;const r=t.newPromise();return e.then(a=>r.resolve(n(a)),a=>r.reject(n(a))),(s=i(e,r))!=null?s:r.handle}function N(t,e){var n,i,s,r,a;const{ctx:o,unmarshal:u,isMarshalable:l,find:d,pre:c}=e;{const g=be(o,t);if(g)return g}{const g=d(t);if(g)return g}const h=l?.(t);if(h===!1)return o.undefined;const m=(g,_)=>c(g,_,h);if(h==="json")return ge(o,t,m);const y=g=>N(g,e);return(a=(r=(s=(i=le(o,t,m,[...fe,...(n=e.custom)!=null?n:[]]))!=null?i:we(o,t,y,m))!=null?s:ve(o,t,y,u,m,e.preApply))!=null?r:_e(o,t,y,m))!=null?a:o.undefined}function xe(t,e,n,i){var s;let r;for(const a of i)if(r=a(e,t),r)break;return r?(s=n(r,e))!=null?s:r:void 0}function Ee(t,e){if(e.typeof(t)!=="symbol")return;const n=e.getString(e.getProp(t,"description"));return Symbol(n)}function Se(t,e){if(!e.dump(v(e,"a => a instanceof Date",void 0,t)))return;const n=e.getNumber(v(e,"a => a.getTime()",void 0,t));return new Date(n)}const je=[Ee,Se];function H(t,e,n,i){t.newFunction("",(s,r)=>{const[a]=i(s);if(typeof a!="string"&&typeof a!="number"&&typeof a!="symbol")return;const o=[["value",!0],["get",!0],["set",!0],["configurable",!1],["enumerable",!1],["writable",!1]].reduce((u,[l,d])=>{const c=t.getProp(r,l),h=t.typeof(c);if(h==="undefined")return u;if(!d&&h==="boolean")return u[l]=t.dump(t.getProp(r,l)),u;const[m,y]=i(c);return y&&c.dispose(),u[l]=m,u},{});Object.defineProperty(n,a,o)}).consume(s=>{v(t,`(o, fn) => {
        const descs = Object.getOwnPropertyDescriptors(o);
        Object.entries(descs).forEach(([k, v]) => fn(k, v));
        Object.getOwnPropertySymbols(descs).forEach(k => fn(k, descs[k]));
      }`,void 0,e,s).dispose()})}function ke(t,e,n,i,s){var r;if(t.typeof(e)!=="function")return;const a=function(...u){return M([n(this),...u.map(l=>n(l))],(l,...d)=>{if(new.target){const[y]=i(v(t,"(Cls, ...args) => new Cls(...args)",l,e,...d));return Object.defineProperties(this,Object.getOwnPropertyDescriptors(y)),this}const c=t.unwrapResult(t.callFunction(e,l,...d)),[h,m]=i(c);return m&&c.dispose(),h})},o=(r=s(a,e))!=null?r:a;return H(t,e,a,i),o}function Pe(t,e,n,i){var s;if(t.typeof(e)!=="object"||t.unwrapResult(t.evalCode("o => o === null")).consume(u=>t.dump(t.unwrapResult(t.callFunction(u,t.undefined,e)))))return;const r=v(t,"Array.isArray",void 0,e).consume(u=>t.dump(u))?[]:{},a=(s=i(r,e))!=null?s:r,o=v(t,`o => {
      const p = Object.getPrototypeOf(o);
      return !p || p === Object.prototype || p === Array.prototype ? undefined : p;
    }`,void 0,e).consume(u=>{if(t.typeof(u)==="undefined")return;const[l]=n(u);return l});return typeof o=="object"&&Object.setPrototypeOf(a,o),H(t,e,r,n),a}function Me(t,e){const n=t.typeof(e);return n==="undefined"||n==="number"||n==="string"||n==="boolean"?[t.dump(e),!0]:n==="object"&&t.unwrapResult(t.evalCode("a => a === null")).consume(i=>t.dump(t.unwrapResult(t.callFunction(i,t.undefined,e))))?[null,!0]:[void 0,!1]}function Oe(t,e,n,i){var s;if(!Re(t,e))return;const r=ye(),[a,o]=n(r.resolve),[u,l]=n(r.reject);return v(t,"(p, res, rej) => { p.then(res, rej); }",void 0,e,a,u),o&&a.dispose(),l&&u.dispose(),(s=i(r.promise,e))!=null?s:r.promise}function Re(t,e){return e.owner?t.unwrapResult(t.evalCode("Promise")).consume(n=>e.owner?re(t,e,n):!1):!1}function Ce(t,e){const[n]=I(t,e);return n}function I(t,e){var n,i,s,r;const{ctx:a,marshal:o,find:u,pre:l}=e;{const[c,h]=Me(a,t);if(h)return[c,!1]}{const c=u(t);if(c)return[c,!0]}const d=c=>I(c,e);return[(r=(s=(i=xe(a,t,l,[...je,...(n=e.custom)!=null?n:[]]))!=null?i:Oe(a,t,o,l))!=null?s:ke(a,t,o,d,l))!=null?r:Pe(a,t,d,l),!1]}class F{constructor(e){p(this,"ctx"),p(this,"_map1",new Map),p(this,"_map2",new Map),p(this,"_map3",new Map),p(this,"_map4",new Map),p(this,"_counterMap",new Map),p(this,"_disposables",new Set),p(this,"_mapGet"),p(this,"_mapSet"),p(this,"_mapDelete"),p(this,"_mapClear"),p(this,"_counter",Number.MIN_SAFE_INTEGER),this.ctx=e;const n=e.unwrapResult(e.evalCode(`() => {
        const mapSym = new Map();
        let map = new WeakMap();
        let map2 = new WeakMap();
        const isObj = o => typeof o === "object" && o !== null || typeof o === "function";
        return {
          get: key => mapSym.get(key) ?? map.get(key) ?? map2.get(key) ?? -1,
          set: (key, value, key2) => {
            if (typeof key === "symbol") mapSym.set(key, value);
            if (isObj(key)) map.set(key, value);
            if (isObj(key2)) map2.set(key2, value);
          },
          delete: (key, key2) => {
            mapSym.delete(key);
            map.delete(key);
            map2.delete(key2);
          },
          clear: () => {
            mapSym.clear();
            map = new WeakMap();
            map2 = new WeakMap();
          }
        };
      }`)).consume(i=>this._call(i,void 0));this._mapGet=e.getProp(n,"get"),this._mapSet=e.getProp(n,"set"),this._mapDelete=e.getProp(n,"delete"),this._mapClear=e.getProp(n,"clear"),n.dispose(),this._disposables.add(this._mapGet),this._disposables.add(this._mapSet),this._disposables.add(this._mapDelete),this._disposables.add(this._mapClear)}set(e,n,i,s){var r;if(!n.alive||s&&!s.alive)return!1;const a=(r=this.get(e))!=null?r:this.get(i);if(a)return a===n||a===s;const o=this._counter++;return this._map1.set(e,o),this._map3.set(o,n),this._counterMap.set(o,e),i&&(this._map2.set(i,o),s&&this._map4.set(o,s)),this.ctx.newNumber(o).consume(u=>{this._call(this._mapSet,void 0,n,u,s??this.ctx.undefined)}),!0}merge(e){if(e)for(const n of e)n&&n[1]&&this.set(n[0],n[1],n[2],n[3])}get(e){var n;const i=(n=this._map1.get(e))!=null?n:this._map2.get(e),s=typeof i=="number"?this._map3.get(i):void 0;if(s){if(!s.alive){this.delete(e);return}return s}}getByHandle(e){if(e.alive)return this._counterMap.get(this.ctx.getNumber(this._call(this._mapGet,void 0,e)))}has(e){return!!this.get(e)}hasHandle(e){return typeof this.getByHandle(e)<"u"}keys(){return this._map1.keys()}delete(e,n){var i;const s=(i=this._map1.get(e))!=null?i:this._map2.get(e);if(typeof s>"u")return;const r=this._map3.get(s),a=this._map4.get(s);this._call(this._mapDelete,void 0,...[r,a].filter(o=>!!(o!=null&&o.alive))),this._map1.delete(e),this._map2.delete(e),this._map3.delete(s),this._map4.delete(s);for(const[o,u]of this._map1)if(u===s){this._map1.delete(o);break}for(const[o,u]of this._map2)if(u===s){this._map2.delete(o);break}for(const[o,u]of this._counterMap)if(u===e){this._counterMap.delete(o);break}n&&(r!=null&&r.alive&&r.dispose(),a!=null&&a.alive&&a.dispose())}deleteByHandle(e,n){const i=this.getByHandle(e);typeof i<"u"&&this.delete(i,n)}clear(){this._counter=0,this._map1.clear(),this._map2.clear(),this._map3.clear(),this._map4.clear(),this._counterMap.clear(),this._mapClear.alive&&this._call(this._mapClear,void 0)}dispose(){for(const e of this._disposables.values())e.alive&&e.dispose();for(const e of this._map3.values())e.alive&&e.dispose();for(const e of this._map4.values())e.alive&&e.dispose();this._disposables.clear(),this.clear()}get size(){return this._map1.size}[Symbol.iterator](){const e=this._map1.keys();return{next:()=>{for(;;){const n=e.next();if(n.done)return{value:void 0,done:!0};const i=this._map1.get(n.value);if(typeof i>"u")continue;const s=this._map3.get(i),r=this._map4.get(i);if(!s)continue;const a=this._get2(i);return{value:[n.value,s,a,r],done:!1}}}}}_get2(e){for(const[n,i]of this._map2)if(i===e)return n}_call(e,n,...i){return this.ctx.unwrapResult(this.ctx.callFunction(e,typeof n>"u"?this.ctx.undefined:n,...i))}}function De(t,e,n,i,s,r,a){if(!x(e)||e instanceof Promise||e instanceof Date||a&&!a(e))return;if(Ae(e,n))return e;const o=new Proxy(e,{get(u,l){return l===n?u:Reflect.get(u,l)},set(u,l,d,c){var h;const m=j(d,n),y=(h=r?.(c))!=null?h:"host";return y!=="vm"&&!Reflect.set(u,l,m,c)||y==="host"||!t.alive||M([s(c),s(l),s(m)],(g,_,R)=>{const[C,G]=O(t,g,i);G?C.consume(B=>t.setProp(B,_,R)):t.setProp(C,_,R)}),!0},deleteProperty(u,l){var d;const c=(d=r?.(o))!=null?d:"host";return M([s(o),s(l)],(h,m)=>{const[y,g]=O(t,h,i);if(c==="vm"||Reflect.deleteProperty(u,l)){if(c==="host"||!t.alive)return!0;g?y.consume(_=>v(t,"(a, b) => delete a[b]",void 0,_,m)):v(t,"(a, b) => delete a[b]",void 0,y,m)}return!0})}});return o}function Fe(t,e,n,i,s,r,a){if(!ie(t,e)||a&&!a(e,t))return[void 0,!1];if(J(t,e,i))return[e,!1];const o=d=>{const c=r?.(s(d));return typeof c=="string"?t.newString(c):t.undefined},u=(d,c,h)=>{const m=s(d);if(!m)return;const y=s(c);if(y==="__proto__")return;const g=s(h);j(m,n)[y]=g},l=(d,c)=>{const h=s(d);if(!h)return;const m=s(c);delete j(h,n)[m]};return t.newFunction("proxyFuncs",(d,...c)=>{switch(t.getNumber(d)){case 1:return o(c[0]);case 2:return u(c[0],c[1],c[2]);case 3:return l(c[0],c[1])}return t.undefined}).consume(d=>[v(t,`(target, sym, proxyFuncs) => {
          const rec =  new Proxy(target, {
            get(obj, key, receiver) {
              return key === sym ? obj : Reflect.get(obj, key, receiver)
            },
            set(obj, key, value, receiver) {
              const v = typeof value === "object" && value !== null || typeof value === "function"
                ? value[sym] ?? value
                : value;
              const sync = proxyFuncs(1, receiver) ?? "vm";
              if (sync === "host" || Reflect.set(obj, key, v, receiver)) {
                if (sync !== "vm") {
                  proxyFuncs(2, receiver, key, v);
                }
              }
              return true;
            },
            deleteProperty(obj, key) {
              const sync = proxyFuncs(1, rec) ?? "vm";
              if (sync === "host" || Reflect.deleteProperty(obj, key)) {
                if (sync !== "vm") {
                  proxyFuncs(3, rec, key);
                }
              }
              return true;
            },
          });
          return rec;
        }`,void 0,e,i,d),!0])}function j(t,e){var n;return x(t)&&(n=t[e])!=null?n:t}function O(t,e,n){return J(t,e,n)?[t.getProp(e,n),!0]:[e,!1]}function Ae(t,e){return x(t)&&!!t[e]}function J(t,e,n){return!!t.dump(v(t,'(a, s) => (a instanceof Promise) || (a instanceof Date) || (typeof a === "object" && a !== null || typeof a === "function") && !!a[s]',void 0,e,n))}class Le{constructor(e,n){p(this,"context"),p(this,"_map"),p(this,"_registeredMap"),p(this,"_registeredMapDispose",new Set),p(this,"_sync",new Set),p(this,"_temporalSync",new Set),p(this,"_symbol",Symbol()),p(this,"_symbolHandle"),p(this,"_options"),p(this,"_isMarshalable",s=>{var r,a;const o=(r=this._options)==null?void 0:r.isMarshalable;return(a=typeof o=="function"?o(this._unwrap(s)):o)!=null?a:"json"}),p(this,"_marshalFind",s=>{var r,a,o;const u=this._unwrap(s);return(o=(a=(r=this._registeredMap.get(s))!=null?r:u!==s?this._registeredMap.get(u):void 0)!=null?a:this._map.get(s))!=null?o:u!==s?this._map.get(u):void 0}),p(this,"_marshalPre",(s,r,a)=>{var o;if(a!=="json")return(o=this._register(s,ce(r),this._map))==null?void 0:o[1]}),p(this,"_marshalPreApply",(s,r,a)=>{const o=x(r)?this._unwrap(r):void 0;o&&this._temporalSync.add(o);try{return s.apply(r,a)}finally{o&&this._temporalSync.delete(o)}}),p(this,"_marshal",s=>{var r,a;const o=this._registeredMap.get(s);if(o)return[o,!1];const u=N((r=this._wrap(s))!=null?r:s,{ctx:this.context,unmarshal:this._unmarshal,isMarshalable:this._isMarshalable,find:this._marshalFind,pre:this._marshalPre,preApply:this._marshalPreApply,custom:(a=this._options)==null?void 0:a.customMarshaller});return[u,!this._map.hasHandle(u)]}),p(this,"_preUnmarshal",(s,r)=>{var a;return(a=this._register(s,r,void 0,!0))==null?void 0:a[0]}),p(this,"_unmarshalFind",s=>{var r;return(r=this._registeredMap.getByHandle(s))!=null?r:this._map.getByHandle(s)}),p(this,"_unmarshal",s=>{var r;const a=this._registeredMap.getByHandle(s);if(typeof a<"u")return a;const[o]=this._wrapHandle(s);return Ce(o??s,{ctx:this.context,marshal:this._marshal,find:this._unmarshalFind,pre:this._preUnmarshal,custom:(r=this._options)==null?void 0:r.customUnmarshaller})}),p(this,"_syncMode",s=>{const r=this._unwrap(s);return this._sync.has(r)||this._temporalSync.has(r)?"both":void 0}),p(this,"_unwrapIfNotSynced",s=>{const r=this._unwrap(s);return r instanceof Promise||!this._sync.has(r)?r:s});var i;n!=null&&n.compat&&!("runtime"in e)&&(e.runtime={hasPendingJob:()=>e.hasPendingJob(),executePendingJobs:s=>e.executePendingJobs(s)}),this.context=n!=null&&n.experimentalContextEx?Z(e):e,this._options=n,this._symbolHandle=e.unwrapResult(e.evalCode("Symbol()")),this._map=new F(e),this._registeredMap=new F(e),this.registerAll((i=n?.registeredObjects)!=null?i:te)}dispose(){var e,n;this._map.dispose(),this._registeredMap.dispose(),this._symbolHandle.dispose(),(n=(e=this.context).disposeEx)==null||n.call(e)}evalCode(e){const n=this.context.evalCode(e);return this._unwrapResultAndUnmarshal(n)}executePendingJobs(e){const n=this.context.runtime.executePendingJobs(e);if("value"in n)return n.value;throw this._unwrapIfNotSynced(n.error.consume(this._unmarshal))}expose(e){for(const[n,i]of Object.entries(e))ae(this._marshal(i),s=>{this.context.setProp(this.context.global,n,s)})}sync(e){const n=this._wrap(e);return typeof n>"u"?e:(me(n,i=>{const s=this._unwrap(i);this._sync.add(s)}),n)}register(e,n){if(this._registeredMap.has(e))return;const i=typeof n=="string"?this._unwrapResult(this.context.evalCode(n)):n;se(this.context,i,this.context.undefined)||(typeof n=="string"&&this._registeredMapDispose.add(e),this._registeredMap.set(e,i))}registerAll(e){for(const[n,i]of e)this.register(n,i)}unregister(e,n){this._registeredMap.delete(e,this._registeredMapDispose.has(e)||n),this._registeredMapDispose.delete(e)}unregisterAll(e,n){for(const i of e)this.unregister(i,n)}startSync(e){if(!x(e))return;const n=this._unwrap(e);this._sync.add(n)}endSync(e){this._sync.delete(this._unwrap(e))}_unwrapResult(e){if("value"in e)return e.value;throw this._unwrapIfNotSynced(e.error.consume(this._unmarshal))}_unwrapResultAndUnmarshal(e){if(e)return this._unwrapIfNotSynced(this._unwrapResult(e).consume(this._unmarshal))}_register(e,n,i=this._map,s){if(this._registeredMap.has(e)||this._registeredMap.hasHandle(n))return;let r=this._wrap(e);const[a]=this._wrapHandle(n),o=e instanceof Promise;if(!a||!r&&!o)return;o&&(r=e);const u=this._unwrap(e),[l,d]=this._unwrapHandle(n);if(i.set(r,a,u,l))s&&this._sync.add(u);else throw d&&l.dispose(),new Error("already registered");return[r,a]}_wrap(e){var n;return De(this.context,e,this._symbol,this._symbolHandle,this._marshal,this._syncMode,(n=this._options)==null?void 0:n.isWrappable)}_unwrap(e){return j(e,this._symbol)}_wrapHandle(e){var n;return Fe(this.context,e,this._symbol,this._symbolHandle,this._unmarshal,this._syncMode,(n=this._options)==null?void 0:n.isHandleWrappable)}_unwrapHandle(e){return O(this.context,e,this._symbolHandle)}}class w{static QuickJS;vm;arena;static async init(){w.QuickJS||(w.QuickJS=await K(q))}constructor(){if(!w.QuickJS)throw new Error("QuickJS not initialized");this.vm=w.QuickJS.newContext(),this.arena=new Le(this.vm,{isMarshalable:!0})}evalCode(e){try{const n=this.arena.evalCode(e);return S.right(n)}catch(n){return n instanceof Error?S.left(n):S.left(new Error(`Unknown error: ${n}`))}}dispose(){this.arena.dispose(),this.vm.dispose()}[Symbol.dispose](){this.vm.dispose()}}const E=U("WorkerScript");await w.init();const T=new w,b=new z,Ne={defineDeviceClass:b.defineDeviceClass.bind(b),getDeviceClass:b.getDeviceClass.bind(b),getDevice:b.getDevice.bind(b),updateDeviceState:b.updateDeviceState.bind(b)};T.arena.expose({console,game:Ne,Types:W});Q(t=>{const e=t;switch(e.type){case"start":E.debug("Received start message");break;case"pause":E.debug("Received pause message");break;case"reset":E.debug("Received reset message");break;case"runScript":E.debug("Received scriptExecution message");const n=T.evalCode(e.script);if(S.isLeft(n)){const i=new Error(n.left.message);n.left.cause&&(i.cause=n.left.cause),n.left.stack&&(i.stack=n.left.stack),n.left.name&&(i.name=n.left.name),n.left.message&&(i.message=n.left.message),A(i)}break;case"event":b.receiveEvent(e.event);break;default:throw new $("Unknown message type")}});A("ready");E.info("Worker script started");
